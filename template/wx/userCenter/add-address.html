<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>{$langdata.add_edit_address}</title>
        <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta content="yes" name="apple-mobile-web-app-capable">
        <meta content="black" name="apple-mobile-web-app-status-bar-style">
        <meta content="telephone=no" name="format-detection">
        <meta content="email=no" name="format-detection">
        <link href="{$STATIC_URL}/phone/css/mobiscroll.custom-2.17.1.min.css"  rel="stylesheet" type="text/css"/>
        <link href="{$STATIC_URL}/phone/css/style.css"  rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="{$STATIC_URL}/plugin/bootstrapswitch/bootstrap-switch.min.css">
        {literal}
        <style type="text/css">
            body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";font-size:14px;}
            #l-map{height:300px;width:100%;}
            #r-result{width:100%;}
        </style>
        {/literal}
    </head>
    <body>
        <div class="addshipaddress-wrap">
            <div class="ss-nav">

                <div class="ss-nav-title">{$langdata.add_edit_address}</div>
            </div>
            <div class="height90" style="height:0.9rem"></div>
            <div class="cate-content clearfix">
                <div id="l-map"></div>
                <div id="r-result">详细地址:<input type="text" id="suggestId" size="20"   style="width:350px; border:1px solid black;height:35px;" /></div>
                <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
                <p></p>
                <input type="hidden" name="latlon" value="{$latlon}">
                <input type="hidden" name="lang" value="{$lang}">
                <input type="hidden" name="storeid" value="{$storeid}">
                <input type="hidden" name="lat" value="{$lat}">
                <input type="hidden" name="lng" value="{$lng}">
                <input type="hidden" name="address" value="">
                <input type="hidden"  name='returnUrl' value="{$returnUrl}"/>
            </div>
            <div class="addshipaddress-save">
                <input type="button" class="submit addshipaddress-save" value="{$langdata.add_edit_Preservation}" style='cursor:pointer;outline:none;border:none;-webkit-appearance : none ;border-radius: 0;'/>
                <input type="hidden"  name="storeid"  value="{$storeid}" >
                <input type="hidden"  name="lang"  value="{$lang}" >
                <input type="hidden"  name="auxiliary"  value="{$auxiliary}" >

            </div>
            <div class="height80"></div>
        </div>   
        <script src="{$STATIC_URL}/phone/js/jquery-2.1.1.min.js" type="text/javascript"></script>
        <script src="{$STATIC_URL}/phone/js/common.js" type="text/javascript"></script>
        <script src="{$STATIC_URL}/phone/js/layer/layer.js" type="text/javascript"></script>
        <script src="{$STATIC_URL}/phone/js/mobiscroll.custom-2.17.1.min.js" type="text/javascript"></script>
        <script src="{$STATIC_URL}/phone/js/index.js" type="text/javascript"></script>
        <script src="{$STATIC_URL}/plugin/bootstrapswitch/bootstrap-switch.min.js"></script>
        {literal}
        <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=CmfcOlGRQE7OztyHtDGLoiiNGYUu37Te"></script>
        <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
        <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />
        <script type="text/javascript">
            // 百度地图API功能
            function G(id) {
                return document.getElementById(id);
            }

            var mp = new BMap.Map("l-map");
            var lat=parseFloat($("input[name='lat']").val());
            var lng=parseFloat($("input[name='lng']").val());
            if (lng == '') {
                var point = new BMap.Point(116.404, 39.915);
            } else {
                var point = new BMap.Point(lng, lat);
            }
            mp.centerAndZoom(point, 11);
            //                                                                        var suggestId = $("#suggestId").attr("value");
            //                                                                        var ac = new BMap.Autocomplete({suggestId, "location": mp
            //                                                                        });//建立一个自动完成的对象
            var ac = new BMap.Autocomplete(//建立一个自动完成的对象
                {"input": "suggestId"
                    , "location": mp
                });
            var marker = new BMap.Marker(point);  // 创建标注
            mp.addOverlay(marker);              // 将标注添加到地图中
            mp.addEventListener("click", function (e) {
                mp.removeOverlay(marker);//删除
                longitude = e.point.lng;
                latitude = e.point.lat;
                var point = new BMap.Point(longitude, latitude);
                var geoc = new BMap.Geocoder();
                mp.centerAndZoom(point, 18);
                marker = new BMap.Marker(point);  // 创建标注
                mp.addOverlay(marker);               // 将标注添加到地图中
                var pt = e.point;
                console.log(pt);
                geoc.getLocation(pt, function (rs) {
                    var addComp = rs.addressComponents;
                    add = (addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber);
                    document.getElementById('suggestId').blur();
                    document.getElementById('suggestId').value = add;
                    $('input[name=address]').val(document.getElementById('suggestId').value);

                });
            });
            window.mp = mp;//将map变量存储在全局
            mp.enableScrollWheelZoom();
            mp.enableInertialDragging();
            mp.enableContinuousZoom();
            ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
                var str = "";
                var _value = e.fromitem.value;
                var value = "";
                if (e.fromitem.index > -1) {
                    value = _value.province + _value.city + _value.district + _value.street + _value.business;
                }
                str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;
                value = "";
                if (e.toitem.index > -1) {
                    _value = e.toitem.value;
                    value = _value.province + _value.city + _value.district + _value.street + _value.business;
                }
                str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
                document.getElementById('suggestId').blur();
                G("searchResultPanel").innerHTML = str;
            });

            var myValue;
            ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
                var _value = e.item.value;
                myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
                G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
                document.getElementById('suggestId').blur();
                setPlace();
            });

            function setPlace() {
                mp.clearOverlays();    //清除地图上所有覆盖物
                function myFun() {
                    var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                    mp.centerAndZoom(pp, 18);
                    longitude = pp.lng;
                    latitude = pp.lat;
                    document.getElementById('longitude').value = longitude;
                    document.getElementById('latitude').value = latitude;
//                                                                mp.addOverlay(new BMap.Marker(pp));    //添加标注
                    marker = new BMap.Marker(pp);  // 创建标注
                    console.log("创建标注 " + marker);
                    mp.addOverlay(marker);  //添加标注
                    flag = false;
                }
                var local = new BMap.LocalSearch(mp, {//智能搜索
                    onSearchComplete: myFun
                });
                local.search(myValue);
            }
        </script>
        <script>
            $('#suggestId').blur(function(){
                $('input[name=address]').val(document.getElementById('suggestId').value);
            });
            $('.submit').click(function () {
                var address=$('input[name=address]').val();
                var returnUrl=$('input[name=returnUrl]').val();
                setTimeout(function () {
                    window.location.href = returnUrl+'&address='+address;
                }, 1000);
            })
        </script>
        {/literal}
    </body>
</html>