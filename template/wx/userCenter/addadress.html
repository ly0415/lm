<!DOCTYPE html>
<html style="font-size:50px;background-color:#fff">
    <head lang="en">
        <meta charset="UTF-8">
        <title></title>
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
        <link rel="stylesheet" href="{$STATIC_URL}/phone/css/style.css"/>
    </head>
    <body>

        <header class="addadress">
            <div class="left">
                <i></i>
                <span id="ress"></span>
            </div>
            <div class="right">
                <input type="text" placeholder="查找小区/大厦、学校等" id="suggestId" name="search" />
            </div>
            <div style="clear:both" ></div>

        </header>
        <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
        <div class="adressmap" id="l-map">

        </div>
        <div class="addressName">


            <!--   <div>
                   <b></b>
                   <span>花神大道23号5号楼</span>
                   <div style="clear: both"></div>
               </div>-->


        </div>
        <input type="hidden" name="latlon" value="{$latlon}">
        <input type="hidden" name="lang" value="{$lang}">
        <input type="hidden" name="storeid" value="{$storeid}">
        <input type="hidden" name="lat" value="{$lat}">
        <input type="hidden" name="lng" value="{$lng}">
        <input type="hidden" name="name" value="{$name}">
        <input type="hidden" name="type" value="{$type}">
        <input type="hidden" name="phone" value="{$phone}">
        <input type="hidden" name="auxiliary" value="{$auxiliary}">
        <input type="hidden" name="mp" value="{$mp}">
        <input type="hidden" name="returnUrl" value="{$returnUrl}">
         <input type="hidden" name="url" value="{$url}">
        <input type="hidden" name="address" >
        <input type="hidden" name="postal" value="{$postal}">
        <input type="hidden" name="id" value="{$id}">
 <input type="hidden" name="addr_id" value="{$addr_id}">
    </body>
    <script src="{$STATIC_URL}/phone/js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="{$STATIC_URL}/phone/js/common.js" type="text/javascript"></script>
    <script src="{$STATIC_URL}/phone/js/layer/layer.js" type="text/javascript"></script>
    <script src="{$STATIC_URL}/phone/js/mobiscroll.custom-2.17.1.min.js" type="text/javascript"></script>
    <script src="{$STATIC_URL}/phone/js/index.js" type="text/javascript"></script>

    {literal}
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=CmfcOlGRQE7OztyHtDGLoiiNGYUu37Te"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />
    <script type="text/javascript">
        // 百度地图API功能
        function G(id) {
            return document.getElementById(id);
        }
        var mp = new BMap.Map("l-map");
        var lat = parseFloat($("input[name='lat']").val());
        var lng = parseFloat($("input[name='lng']").val());
        if (lng == '') {
            var point = new BMap.Point(116.404, 39.915);
        } else {
            var point = new BMap.Point(lng, lat);
        }

        //经纬度转化为地址
        mp.centerAndZoom(point, 12);
        var geoc = new BMap.Geocoder();
        var point = new BMap.Point(lng, lat);
        geoc.getLocation(point, function (rs) {
            var addComp = rs.addressComponents;
            $('#ress').text(addComp.province + addComp.city);
            var options = {
                onSearchComplete: function (results) {
                    var name = $('input[name=name]').val();
                    var phone = $('input[name=phone]').val();
                    var mp = $('input[name=mp]').val();
                    var storeid = $('input[name=storeid]').val();
                    var lang = $('input[name=lang]').val();
                    var id = $('input[name=id]').val();
                    var addr_id = $('input[name=addr_id]').val();
                    var auxiliary = $('input[name=auxiliary]').val();
                    var latlon = $('input[name=latlon]').val();
                    var postal = $('input[name=postal]').val();
                    var returnUrl = $('input[name=returnUrl]').val();
                     var url = $('input[name=url]').val();
                    // 判断状态是否正确
                    if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                        var s = [];
                        var nowlatlon = [];
                        for (var i = 0; i < results.getCurrentNumPois(); i++) {
                            s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                            nowlatlon.push(results.getPoi(i).point.lng + "," + results.getPoi(i).point.lat);
                        }
                        var str = '';
                        var a = '';
                        for (var i = 0; i < s.length; i++) {

                            a = "wx.php?app=userCenter&act=addAddress1&addr_id=" + addr_id + "&id=" + id + "&storeid=" + storeid + "&lang=" + lang + "&auxiliary=" + auxiliary + "&latlon=" + latlon + "&name=" + name +
                                    "&phone=" + phone + "&mp=" + mp + "&nowlatlon=" + nowlatlon[i] + "&postal=" + postal + "&returnUrl=" + returnUrl+ "&url=" + url + "&address=" + s[i];
                            str += '<div><b></b><a href=' + a + '><span>' + s[i] + '</span></a><div style="clear:both"></div></div>';
                        }
                        $('.addressName').html('');
                        $('.addressName').html(str);
                    }
                }
            };

            var local = new BMap.LocalSearch(mp, options);
            local.search(addComp.street);


        });

        mp.centerAndZoom(point, 11);
        var ac = new BMap.Autocomplete(//建立一个自动完成的对象
                {"input": "suggestId",
                    "location": mp,
                    "onSearchComplete": function (result) {
                        ac.hide();
                    }
                });
        var marker = new BMap.Marker(point);  // 创建标注
        mp.addOverlay(marker);              // 将标注添加到地图中





        mp.addEventListener("click", function (e) {
            mp.removeOverlay(marker);//删除
            longitude = e.point.lng;
            latitude = e.point.lat;
            var point = new BMap.Point(longitude, latitude);
            var geoc = new BMap.Geocoder();
            mp.centerAndZoom(point, 18);
            marker = new BMap.Marker(point);  // 创建标注
            mp.addOverlay(marker);               // 将标注添加到地图中
            var pt = e.point;
            geoc.getLocation(pt, function (rs) {
                var addComp = rs.addressComponents;
                /*  var latlon=rs.point.lng+','+rs.point.lat;*/
                add = (addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber);
                document.getElementById('suggestId').blur();
                document.getElementById('suggestId').value = add;
                $('input[name=address]').val(add);
                /*    $('input[name=latlon]').val(latlon);*/
                var options = {
                    onSearchComplete: function (results) {
                        var name = $('input[name=name]').val();
                        var phone = $('input[name=phone]').val();
                        var mp = $('input[name=mp]').val();
                        var storeid = $('input[name=storeid]').val();
                        var lang = $('input[name=lang]').val();
                        var auxiliary = $('input[name=auxiliary]').val();
                        var latlon = $('input[name=latlon]').val();
                        var postal = $('input[name=postal]').val();
                        var returnUrl = $('input[name=returnUrl]').val();
                        var url = $('input[name=url]').val();
                         var id = $('input[name=id]').val();
                        // 判断状态是否正确
                        if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                            var s = [];
                            var nowlatlon = [];
                            for (var i = 0; i < results.getCurrentNumPois(); i++) {
                                s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                                nowlatlon.push(results.getPoi(i).point.lng + "," + results.getPoi(i).point.lat);

                            }
                            var str = '';
                            var a = '';
                            for (var i = 0; i < s.length; i++) {

                                a = "wx.php?app=userCenter&act=addAddress1&storeid=" + storeid + "&lang=" + lang + "&auxiliary=" + auxiliary + "&latlon=" + latlon + "&id=" + id + "&name=" + name +
                                        "&phone=" + phone + "&mp=" + mp + "&nowlatlon=" + nowlatlon[i] + "&postal=" + postal + "&returnUrl=" + returnUrl+ "&url=" + url + "&address=" + s[i];
                                str += '<div><b></b><a href=' + a + '><span>' + s[i] + '</span></a><div style="clear:both"></div></div>';
                            }
                            $('.addressName').html('');
                            $('.addressName').html(str);
                        }
                    }
                };

                var local = new BMap.LocalSearch(mp, options);
                local.search(add);

            });
        });
        window.mp = mp;//将map变量存储在全局

        mp.enableScrollWheelZoom();
        mp.enableInertialDragging();
        mp.enableContinuousZoom();
        /*    ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
         var str = "";
         var _value = e.fromitem.value;
         var value = "";
         if (e.fromitem.index > -1) {
         value = _value.province + _value.city + _value.district + _value.street + _value.business;
         }
         str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;
         value = "";
         if (e.toitem.index > -1) {
         _value = e.toitem.value;
         value = _value.province + _value.city + _value.district + _value.street + _value.business;
         }
         str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
         document.getElementById('suggestId').blur();
         G("searchResultPanel").innerHTML = str;
         });*/

        var myValue;




        //键盘搜索
        $("#suggestId").on('keypress', function (e) {
            var keycode = e.keyCode;
            var searchname = $('input[name=search]').val();

            if (keycode == '13') {
                var options = {
                    onSearchComplete: function (results) {
                        var name = $('input[name=name]').val();
                        var phone = $('input[name=phone]').val();
                        var mp = $('input[name=mp]').val();
                        var storeid = $('input[name=storeid]').val();
                        var lang = $('input[name=lang]').val();
                        var auxiliary = $('input[name=auxiliary]').val();
                        var latlon = $('input[name=latlon]').val();
                        var postal = $('input[name=postal]').val();
                        var returnUrl = $('input[name=returnUrl]').val();
                        var url = $('input[name=url]').val();
                         var id = $('input[name=id]').val();
                        // 判断状态是否正确
                        if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                            var s = [];
                            var nowlatlon = [];
                            for (var i = 0; i < results.getCurrentNumPois(); i++) {
                                s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                                nowlatlon.push(results.getPoi(i).point.lng + "," + results.getPoi(i).point.lat);
                            }
                            var str = '';
                            var a = '';
                            for (var i = 0; i < s.length; i++) {
                                a = "wx.php?app=userCenter&act=addAddress1&storeid=" + storeid + "&lang=" + lang + "&auxiliary=" + auxiliary + "&latlon=" + latlon + "&id=" + id + "&name=" + name +
                                        "&phone=" + phone + "&mp=" + mp + "&nowlatlon=" + nowlatlon[i] + "&postal=" + postal + "&returnUrl=" + returnUrl+ "&url=" + url + "&address=" + s[i];
                                str += '<div><b></b><a href=' + a + '><span>' + s[i] + '</span></a><div style="clear:both"></div></div>';
                            }
                            $('.addressName').html('');
                            $('.addressName').html(str);
                        }
                    }
                };

                var local = new BMap.LocalSearch(mp, options);
                local.search(searchname);


            }
        });
        //单击搜索
        $('.right').click(function () {
            var searchname = $('input[name=search]').val();
            var options = {
                onSearchComplete: function (results) {
                    var name = $('input[name=name]').val();
                    var phone = $('input[name=phone]').val();
                    var mp = $('input[name=mp]').val();
                    var storeid = $('input[name=storeid]').val();
                    var lang = $('input[name=lang]').val();
                    var auxiliary = $('input[name=auxiliary]').val();
                    var latlon = $('input[name=latlon]').val();
                    var postal = $('input[name=postal]').val();
                    var returnUrl = $('input[name=returnUrl]').val();
                     var url = $('input[name=url]').val();
                       var id = $('input[name=id]').val();
                    // 判断状态是否正确
                    if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                        var s = [];
                        var nowlatlon = [];
                        for (var i = 0; i < results.getCurrentNumPois(); i++) {
                            s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                            nowlatlon.push(results.getPoi(i).point.lng + "," + results.getPoi(i).point.lat);
                        }
                        var str = '';
                        var a = '';
                        for (var i = 0; i < s.length; i++) {

                            a = "wx.php?app=userCenter&act=addAddress1&storeid=" + storeid + "&lang=" + lang + "&auxiliary=" + auxiliary + "&latlon=" + latlon + "&id=" + id + "&name=" + name +
                                    "&phone=" + phone + "&mp=" + mp + "&nowlatlon=" + nowlatlon[i] + "&postal=" + postal + "&returnUrl=" + returnUrl+ "&url=" + url + "&address=" + s[i];
                            str += '<div><b></b><a href=' + a + '><span>' + s[i] + '</span></a><div style="clear:both"></div></div>';
                        }
                        $('.addressName').html('');
                        $('.addressName').html(str);
                    }
                }
            };

            var local = new BMap.LocalSearch(mp, options);
            local.search(searchname);




        });





        ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
            /* G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;*/
            document.getElementById('suggestId').blur();
            var options = {
                onSearchComplete: function (results) {
                    var name = $('input[name=name]').val();
                    var phone = $('input[name=phone]').val();
                    var mp = $('input[name=mp]').val();
                    var storeid = $('input[name=storeid]').val();
                    var lang = $('input[name=lang]').val();
                    var auxiliary = $('input[name=auxiliary]').val();
                    var latlon = $('input[name=latlon]').val();
                    var postal = $('input[name=postal]').val();
                    var returnUrl = $('input[name=returnUrl]').val();
                     var url = $('input[name=url]').val();
                       var id = $('input[name=id]').val();
                    // 判断状态是否正确
                    if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                        var s = [];
                        var nowlatlon = [];
                        for (var i = 0; i < results.getCurrentNumPois(); i++) {
                            s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                            nowlatlon.push(results.getPoi(i).point.lng + "," + results.getPoi(i).point.lat);
                        }
                        var str = '';
                        var a = '';
                        for (var i = 0; i < s.length; i++) {

                            a = "wx.php?app=userCenter&act=addAddress1&storeid=" + storeid + "&lang=" + lang + "&auxiliary=" + auxiliary + "&latlon=" + latlon + "&id=" + id + "&name=" + name +
                                    "&phone=" + phone + "&mp=" + mp + "&nowlatlon=" + nowlatlon[i] + "&postal=" + postal + "&returnUrl=" + returnUrl + "&url=" + url + "&address=" + s[i];
                            str += '<div><b></b><a href=' + a + '><span>' + s[i] + '</span></a><div style="clear:both"></div></div>';
                        }
                        $('.addressName').html('');
                        $('.addressName').html(str);
                    }
                }
            };

            var local = new BMap.LocalSearch(mp, options);
            local.search(myValue);


        });

        /*    function boxHide() {
         console.log(this.value);
         if (this.value) {
         if (keywords) {//发起某个关键字的提示请求，会引起onSearchComplete的回调
         ac.search.apply(ac, keywords);
         }
         hideRestAcBox();
         } else {
         hideAcBox();
         }
         }*/

        /*   function setPlace() {
         mp.clearOverlays();    //清除地图上所有覆盖物
         function myFun() {
         var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
         mp.centerAndZoom(pp, 18);
         longitude = pp.lng;
         latitude = pp.lat;
         document.getElementById('longitude').value = longitude;
         document.getElementById('latitude').value = latitude;
         //                                                                mp.addOverlay(new BMap.Marker(pp));    //添加标注
         marker = new BMap.Marker(pp);  // 创建标注
         console.log("创建标注 " + marker);
         mp.addOverlay(marker);  //添加标注
         flag = false;
         }
         var local = new BMap.LocalSearch(mp, {//智能搜索
         
         onSearchComplete: myFun
         });
         local.search(myValue);
         }*/

        /*    var options = {
         onSearchComplete: function(results){
         // 判断状态是否正确
         if (local.getStatus() == BMAP_STATUS_SUCCESS){
         var s = [];
         for (var i = 0; i < results.getCurrentNumPois(); i ++){
         s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
         }
         document.getElementById("r-result").innerHTML = s.join("<br/>");
         }
         }
         };
         var local = new BMap.LocalSearch(map, options);
         local.search("公园");*/



    </script>
    <script>/*
     $('#suggestId').blur(function(){
     $('input[name=address]').val(document.getElementById('suggestId').value);
     });*/
        /*$('.submit').click(function () {
         /!* var address=$('input[name=address]').val();*!/
         var returnUrl=$('input[name=returnUrl]').val();
         var latlon=$('input[name=latlon]').val();
         setTimeout(function () {
         var url=changeURLArg(returnUrl,'latlon',latlon);
         window.location.href =url;
         }, 1000);
         })
         
         function changeURLArg(url,arg,arg_val){
         var pattern=arg+'=([^&]*)';
         var replaceText=arg+'='+arg_val;
         if(url.match(pattern)){
         var tmp='/('+ arg+'=)([^&]*)/gi';
         tmp=url.replace(eval(tmp),replaceText);
         return tmp;
         }else{
         if(url.match('[\?]')){
         return url+'&'+replaceText;
         }else{
         return url+'?'+replaceText;
         }
         }
         return url+'\n'+arg+'\n'+arg_val;
         }*/

    </script>
    {/literal}
</body>


</html>