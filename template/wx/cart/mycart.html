<!DOCTYPE html>
<html style="font-size:50px">
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <title></title>
    <link rel="stylesheet" href="{$STATIC_URL}/phone/css/style.css"/>
    <script src="{$STATIC_URL}/phone/js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <style>
        input[type='checkbox']{
            width: 20px;
            height: 20px;
            background-color: #fff;
            -webkit-appearance:none;
            border:0;
            border-radius:50%;
            outline: none;
            background: url({$STATIC_URL}/phone/images/check1.png)no-repeat center;
        }
        .checkBox input[type=checkbox]:checked{
            background: url({$STATIC_URL}/phone/images/check-check.png)no-repeat 40% 50%;
            background-size: 90%;
        }
        div.cartList-item .productMsg .productLeft img {
            width: 100%;
            height:2.5rem;
        }
    </style>
</head>
<body>
<div class="mycartHeader">
    <div class="cartTxt">
        <span>购物车</span>
        <span class="totalCount">(3)</span>
    </div>
    <div class="manage">管理</div>
</div>
<!--购物车内容-->
<div style="height:1rem">   <input type="hidden" name="symbol"      value="{$symbol}"/>
    <input type="hidden" name="lang"        value="{$lang}"/>
    <input type="hidden" name="auxiliary"   value="{$auxiliary}"/>
    <input type="hidden" name="latlon"      value="{$latlon}"></div>
<div class="mycartSection">

    {foreach from=$cartInfo key=key item=vo}
    <div class="cartList">
        <!--店铺名称-->

        <div class="store">
            <label class="checkBox"><input name ="checks" class="storeCheck" type="checkbox" store_id="{$key}"></label>
            <a href="wx.php?app=goodList&act=index&storeid={$vo.store_id}&lang=29&rtid={$vo.buss_id}&order=1">
            <div class="storeMsg">
                <div class="storeIcon">
                    <img src="{$vo['logo']}" alt=""/>
                </div>
                <span class="storeName">{$vo['store_name']}</span>
                <img class="go" src="{$STATIC_URL}/phone/images/go.png" alt=""/>
            </div>
            </a>
        </div>

        {foreach from=$vo['child'] item=v}
        <!--店铺内的商品-->
        <div class="cartList-item">
            <label class="checkBox"><input name ="checks" type="checkbox" cart_id = "{$v.id}"></label>
            <div class="productMsg">
                <div class="productLeft">
                    <img src="{$v.original_img}" alt=""/>
                </div>
                <div class="productRight">
                    <div class="pname">{$v.goods_name}</div>
                    <div class="pStyle">
                        <span>规格:</span>
                        <span>{$v.spec_key_name}</span>
                    </div>
                    <div class="pbox">
                        <span class="price">{$symbol}{$v.goods_price}</span>
                        <div class="countBox">
                            <button class="pre">-</button>
                            <button class="count">{$v.goods_num}</button>
                            <button class="next">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {/foreach}
    </div>
    {/foreach}
</div>
<!--底部结算-->
<div class="footerBuy">
    <div class="footerLeft">
        <label class="checkBox"><input type="checkbox">全选</label>
        <div class="totalPrice totalPrice1">
            <span class="yf">不含运费</span>
            <div>
                <span class="hj">合计:</span>
                <span class="total">{$symbol} 0.00</span>
            </div>
        </div>
    </div>
    <div class="buy btn-settle">结算 <span class="checkCount">(0)</span></div>
</div>
<!--删除-->
<div class="footerBuy1">
    <div class="footerLeft">
        <label class="checkBox"><input type="checkbox">全选</label>
    </div>
    <div class="delete">删除</div>
</div>
<input type="hidden" name="gao" value="{$gao}">
<script src="{$STATIC_URL}/phone/layui/layui.all1.js" type="text/javascript"></script>
{literal}
<script type="text/javascript">
    function same1(){
        var cartList = $("div.cartList-item");
        var arr=[];
        for (var i = 0; i < cartList.length; i++) {
            var item = cartList[i];
            var checkbox = $(item).find('input[name="checks"]');
            if (checkbox.is(':checked')) {
                var storeId = checkbox.parent().parent().parent().find("div.store .storeCheck").attr("store_id");
                arr.push(storeId);
            }
        }
        arr=unique(arr);
        if(arr.length>1){
            layer.msg('请选择相同店铺商品进行结算',{icon:2});
        }else if(arr.length==1){
            //获取cartId
            var id=arr[0];
            var cartList =$("input[store_id" + "=" + id + "]").parent().parent().nextAll();
            var arr1=[];
            for (var i = 0; i < cartList.length; i++) {
                var item = cartList[i];
                var checkbox = $(item).find('input[name="checks"]');
                if (checkbox.is(':checked')) {
                    var  dataId= checkbox.attr("cart_id");
                    arr1.push(dataId);
                }
            }
            var arr2=arr1.join(",");
            var store_id    = $('input[name=store_id]').val();
            var langId      = $('input[name=lang]').val();
            var auxiliary   = $('input[name=auxiliary]').val();
            var latlon      = $('input[name=latlon]').val();
            var  gao        =$("input[name=gao]").val();
            $.ajax({
                url: 'wx.php?app=cart&act=checkCartData',
                type: 'post',
                data: {'store_id': store_id, 'lang_id': langId,'cart_ids': arr2},
                async: false, //默认为true 异步
                error: function () {
                    alert('error');
                },
                success: function (data) {
                    var data = eval("(" + data + ")");
                    if (data.status == 1) {//用户名不存在需要注册！
                        setTimeout(function (){
                            window.location = data.info.url;
                        }, 1000);
                    }else{
                        layer.open({
                            shade: false,
                            content: " <i class='ico ico-error'>        </i>" + data.message,
                            className: 'layer-tip',
                            time: 1000
                        });
                    }
                }

            });
        }else if(arr.length==0){
            layer.msg("请勾选结算商品，进行结算!",{icon: 0});
        }
    }
    function unique(arr) {
        var ret = []
        var hash = {}

        for (var i = 0; i < arr.length; i++) {
            var item = arr[i]
            if (hash[item] !== 1) {
                ret.push(item)
                hash[item] = 1
            }
        }

        return ret
    }
    $(".buy").click(function(){
        same1();
    });
</script>
<script>
    var flag=true;
    $("div.manage").click(function(){
        if(flag){
            $(this).html("完成");
            $(".footerBuy").css("display","none");
            $(".footerBuy1").css("display","flex");
            flag=false;
        }else{
            $(this).html("管理");
            $(".footerBuy1").css("display","none");
            $(".footerBuy").css("display","flex");
            flag=true;

        }
    });

    //默认一进页面全部选中
    $('.footerLeft input').prop("checked", true);
    $('input[name="checks"]').prop("checked", true);
    getTotalPrice();
    //店铺全选
    $(".store input.storeCheck").click(function () {
        //找到所有商品前的chexckbox
        var chbs = $(this).parent().parent().parent().find("div.cartList-item input");
        for (var i = 0; i < chbs.length; i++) {
            chbs[i].checked = this.checked;
        }
    })

    //全选
    $(".footerLeft input").click(function () {
        var that = this;
        //保证管理和删除界面 全选按钮状态要一致
        $(".footerLeft input").each(function(){
            $(this)[0].checked = that.checked;
        });
        //找到所有商品前的chexckbox
        var chbs = $('input[name="checks"]');
        for (var i = 0; i < chbs.length; i++) {
            chbs[i].checked = this.checked;
        }
        getTotalPrice();
    })
    //点击商品前面的checkbox
    $("body").on("click", 'input[name="checks"]', function () {
        allStoreChk($(this));//判断店铺全选状态
        allchk();//判断全选按钮的选中状态
        getTotalPrice();
    });
    function allchk() {
        var chknum = $('input[name="checks"]').size();
        var chk = 0;
        $('input[name="checks"]').each(function () {
            if ($(this).is(":checked")) {
                chk++;
            }
        });
        if (chknum == chk) {
            $(".footerLeft input").each(function(){
                $(this).prop("checked", true);
            });
        } else {
            $(".footerLeft input").each(function(){
                $(this).prop("checked", false);
            });
        }
    }
    function allStoreChk(element){
        if(!element.hasClass('storeCheck')){
            //获取商铺下面所有的input
            var allStoreNum = element.parent().parent().parent().find("div.cartList-item input").size();
            var chk = 0;
            element.parent().parent().parent().find("div.cartList-item input").each(function () {
                if ($(this).is(":checked")) {
                    chk++;
                }
            });
            if(allStoreNum == chk){
                element.parent().parent().parent().find("div.store input").prop("checked", true);
            }else{
                element.parent().parent().parent().find("div.store input").prop("checked", false);
            }
        }
    }

    //加减按钮的点击
    $(".cartList-item").on('click', '.next', function () {
        //获取data-id
        var dataId=$(this).parent().parent().prev().parent().prev().parent().prev().find("input").attr("cart_id");
        var count = parseInt($(this).prev().html());
        var selectEle = $(this);
        count++;
        $.ajax({
            url: 'wx.php?app=cart&act=doChangeNum',
            type: 'post',
            data: {'cart_id': dataId, 'goods_num': count},
            async: false, //默认为true 异步
            error: function () {
                alert('error');
            },
            success: function (data) {
                var data = eval("(" + data + ")");
                if (data.status == 1) {//用户名不存在需要注册！
                    selectEle.prev().html(count);
                    getTotalPrice();
                }else{
                    layer.open({
                        shade: false,
                        content: " <i class='ico ico-error'>        </i>" + data.message,
                        className: 'layer-tip',
                        time: 1000
                    });
                }
            }
        });

    })
    $(".cartList-item").on('click', '.pre', function () {
        //获取data-id
        var dataId=$(this).parent().parent().prev().parent().prev().parent().prev().find("input").attr("cart_id");

        var count = parseInt($(this).next().html());
        if (count > 1) {
            count--;
            $.ajax({
                url: 'wx.php?app=cart&act=doChangeNum',
                type: 'post',
                data: {'cart_id': dataId, 'goods_num': count},
                async: false, //默认为true 异步
                error: function () {
                    alert('error');
                },
                success: function (data) {
                    var data = eval("(" + data + ")");
                    if (data.status == 1) {//用户名不存在需要注册！

                    }
                }
            });
            $(this).next().html(count);

        } else if (count == 1) {
            return false;
        }

        getTotalPrice();
    });

    //计算总价和总数量
    function getTotalPrice() {
        var totalPrice = 0;
        var allCount = 0;
        var allCount1 = 0;
        var cartList = $("div.cartList-item");
        for (var i = 0; i < cartList.length; i++) {
            var item = cartList[i];
            var count1 = parseInt($(item).find(".count").html());
            allCount += count1;//购物车所有总数
            var checkbox = $(item).find('input[name="checks"]');
            var c=0;
            if (checkbox.is(':checked')) {
                c++;
                var price = parseFloat($(item).find(".price").html().slice(1));
                var count = parseInt($(item).find(".count").html());
                totalPrice += price * count;
                //选中的商品种类
                allCount1+=c;
            }
        }
        $("span.totalCount").html("("+allCount+")");
        if (allCount1== 0) {
            $("span.total").html(0);
            $("span.checkCount").html("("+allCount1+")");
        } else {
            $("span.total").html((totalPrice).toFixed(2));
            $("span.checkCount").html("("+allCount1+")");
        }
    }

    //删除
    $(".delete").click(function(){
        var cartList = $("div.cartList");
        var arr=[];
        for (var i = 0; i < cartList.length; i++) {
            var item = cartList[i];
            //判断商铺是否选中
            var storeCheckBox = $(item).find(".storeCheck");
            if(storeCheckBox.is(":checked")){
                var cartList1=storeCheckBox.parent().parent().nextAll();
                for(var j=0;j<cartList1.length;j++){
                    var dataId=$(cartList1[j]).find('input[name="checks"]').attr("cart_id")
                    arr.push(dataId);
                }
                $(item).remove();
            }else{
                var checkBoxList = $(item).find('div.cartList-item input');
                checkBoxList.each(function(){
                    if($(this).is(":checked")){
                        var dataId=$(this).attr("cart_id");
                        arr.push(dataId);
                        $(this).parent().parent().remove();
                    }
                })
            }
        }
        getTotalPrice();

        var string=arr.join(",");

         $.ajax({
              url: 'wx.php?app=cart&act=dele',
              type: 'GET',
              data: {id: string},
              dataType: 'json',
              success: function (res) {
                  //如果所有商品都删除了,隐藏删除按钮那一栏,全选按钮设置为未选择
                  if($("div.mycartSection").html().trim()==""){
                      $("div.footerBuy1").css("display","none");
                      $(".totalCount").html("(0)");
                      $(".footerLeft input").each(function(){
                          $(this).prop("checked", false);
                      });
                  }
              }
          })



    });
</script>
{/literal}
</body>
</html>