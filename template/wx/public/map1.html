<!DOCTYPE html>
<html style="font-size:50px;background-color:#fff;overflow-x:hidden">
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <link rel="stylesheet" href="{$STATIC_URL}/phone/css/style.css"/>
    <link rel="stylesheet" type="text/css" href="{$STATIC_URL}/phone/css/city-picker.css">
    <link rel="stylesheet" type="text/css" href="{$STATIC_URL}/phone/css/main.css">
</head>
<body style="position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;">

<header class="addadress" style="width:100%;">
    <div class="left">

            <div style="position: relative;">
                <!-- container -->
                <input readonly type="text" data-toggle="city-picker"  name="city">
            </div>


    </div>
    <div class="right sou">
        <input type="text" placeholder="查找小区/大厦、学校等" id="suggestId" name="search" />
    </div>
    <div style="clear:both" ></div>

</header>
<div id="searchResultPanel" style="border:1px solid #C0C0C0;width:100%;height:auto; display:none;"></div>
<div class="adressmap" id="l-map" style="width:100%;">

</div>
<div class="addressName">
</div>
<input type="hidden" name="latlon" value="{$latlon}">
<input type="hidden" name="lang" value="{$lang}">
<input type="hidden" name="storeid" value="{$storeid}">
<input type="hidden" name="lat" value="{$lat}">
<input type="hidden" name="lng" value="{$lng}">
<input type="hidden" name="auxiliary" value="{$auxiliary}">
<input type="hidden" name="address" >
<input type="hidden" name="qu" value="{$qu}">
</body>
<script src="{$STATIC_URL}/phone/js/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="{$STATIC_URL}/phone/js/common.js" type="text/javascript"></script>
<script src="{$STATIC_URL}/phone/js/layer/layer.js" type="text/javascript"></script>
<script src="{$STATIC_URL}/phone/js/mobiscroll.custom-2.17.1.min.js" type="text/javascript"></script>
<script src="{$STATIC_URL}/phone/js/index.js" type="text/javascript"></script>
<script src="{$STATIC_URL}/phone/js/city-picker.data.js"></script>
<script type="text/javascript" src="{$STATIC_URL}/phone/js/city-picker.js"></script>

{literal}
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=CmfcOlGRQE7OztyHtDGLoiiNGYUu37Te"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />
<script type="text/javascript">
    // 百度地图API功能
    function G(id) {
        return document.getElementById(id);
    }
    var mp = new BMap.Map("l-map");
    var lat=parseFloat($("input[name='lat']").val());
    var lng=parseFloat($("input[name='lng']").val());
    if (lng == '') {
        var point = new BMap.Point(116.404, 39.915);
    } else {
        var point = new BMap.Point(lng, lat);
    }
    //经纬度转化为地址
    mp.centerAndZoom(point,12);
    var geoc = new BMap.Geocoder();
    var point =new BMap.Point(lng,lat);
    var qu=$('input[name=qu]').val();
    geoc.getLocation(point, function(rs){
        var addComp = rs.addressComponents;
        //显示地址
        $('.title').css('display','inline');
        $('.city-piker-span').addClass('focus');
        if(qu==''){
            qu=addComp.city;
        }
        $('.placeholder').css('display','none');
        var str='<span class="select-item" data-count="province" data-code="1">'+addComp.province+'</span>'+"/"+
         '<span class="select-item" data-count="city" data-code="2805">'+qu+'</span>';
        $('.title').append('');
        $('.title').append(str);
        var options = {
            onSearchComplete: function(results){
                var name = $('input[name=name]').val();
                var phone = $('input[name=phone]').val();
                var mp=$('input[name=mp]').val();
                var storeid=$('input[name=storeid]').val();
                var lang=$('input[name=lang]').val();
                var auxiliary=$('input[name=auxiliary]').val();
                var latlon=$('input[name=latlon]').val();
                var type=$('input[name=type]').val();
                var returnUrl=$('input[name=returnUrl]').val();
                // 判断状态是否正确
                if (local.getStatus() == BMAP_STATUS_SUCCESS){
                    var s = [];
                    var latlon=[];
                    for (var i = 0; i < results.getCurrentNumPois(); i ++){
                        s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                        latlon.push(results.getPoi(i).point.lng+","+results.getPoi(i).point.lat);
                    }
                    var str ='';
                    var a='';
                    for(var i=0;i<s.length;i++){
                        a="wx.php?app=default&act=index&storeid="+storeid+"&lang="+lang+"&qu="+qu+"&latlon="+latlon[i]+"&address="+s[i];
                        str +='<div><b></b><a href='+a+'><span>'+s[i]+'</span></a><div style="clear:both"></div></div>';
                    }
                    $('.addressName').html('');
                    $('.addressName').html(str);
                }
            }
        };
        var local = new BMap.LocalSearch(mp, options);
        local.search(addComp.street);
    });
    mp.centerAndZoom(point, 11);
    var ac = new BMap.Autocomplete(//建立一个自动完成的对象
        {"input": "suggestId",
            "location": mp,
            "onSearchComplete":function(result){
                ac.hide();
            }
        });
    var marker = new BMap.Marker(point);  // 创建标注
    mp.addOverlay(marker);              // 将标注添加到地图中
    mp.addEventListener("click", function (e) {
        mp.removeOverlay(marker);//删除
        longitude = e.point.lng;
        latitude = e.point.lat;
        var point = new BMap.Point(longitude, latitude);
        var geoc = new BMap.Geocoder();
        mp.centerAndZoom(point, 18);
        marker = new BMap.Marker(point);  // 创建标注
        mp.addOverlay(marker);               // 将标注添加到地图中
        var pt = e.point;
        geoc.getLocation(pt, function (rs) {
            var addComp = rs.addressComponents;
            var latlon=rs.point.lng+','+rs.point.lat;
            $('#ress').text(addComp.province  + addComp.city);
            add = (addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber);
            document.getElementById('suggestId').blur();
            document.getElementById('suggestId').value = add;
            $('input[name=address]').val(add);
            $('input[name=latlon]').val(latlon);
            var options = {
                onSearchComplete: function(results){
                    var name = $('input[name=name]').val();
                    var phone = $('input[name=phone]').val();
                    var mp=$('input[name=mp]').val();
                    var storeid=$('input[name=storeid]').val();
                    var lang=$('input[name=lang]').val();
                    var auxiliary=$('input[name=auxiliary]').val();
                    var latlon=$('input[name=latlon]').val();
                    var type=$('input[name=type]').val();
                    var returnUrl=$('input[name=returnUrl]').val();
                    // 判断状态是否正确
                    if (local.getStatus() == BMAP_STATUS_SUCCESS){
                        var s = [];
                        var latlon=[];
                        for (var i = 0; i < results.getCurrentNumPois(); i ++){
                            s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                            latlon.push(results.getPoi(i).point.lng+","+results.getPoi(i).point.lat);
                        }
                        var str ='';
                        var a='';
                        for(var i=0;i<s.length;i++){
                            a="wx.php?app=default&act=index&storeid="+storeid+"&lang="+lang+"&latlon="+latlon[i]+"&qu="+qu+"&address="+s[i];
                            str +='<div><b></b><a href='+a+'><span>'+s[i]+'</span></a><div style="clear:both"></div></div>';
                        }
                        $('.addressName').html('');
                        $('.addressName').html(str);
                    }
                }
            };

            var local = new BMap.LocalSearch(mp, options);
            local.search(add);

        });
    });
    window.mp = mp;//将map变量存储在全局
    mp.enableScrollWheelZoom();
    mp.enableInertialDragging();
    mp.enableContinuousZoom();
    /*    ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;
            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            document.getElementById('suggestId').blur();
            G("searchResultPanel").innerHTML = str;
        });*/
    var myValue;
    //键盘搜索
    $("#suggestId").on('keypress', function (e) {
        var keycode = e.keyCode;
        var searchname = $('input[name=search]').val();
        if (keycode == '13') {
            var options = {
                onSearchComplete: function(results){
                    var name = $('input[name=name]').val();
                    var phone = $('input[name=phone]').val();
                    var mp=$('input[name=mp]').val();
                    var storeid=$('input[name=storeid]').val();
                    var lang=$('input[name=lang]').val();
                    var auxiliary=$('input[name=auxiliary]').val();
                    var latlon=$('input[name=latlon]').val();
                    var type=$('input[name=type]').val();
                    var returnUrl=$('input[name=returnUrl]').val();
                    // 判断状态是否正确
                    if (local.getStatus() == BMAP_STATUS_SUCCESS){
                        var s = [];
                        var latlon=[];
                        for (var i = 0; i < results.getCurrentNumPois(); i ++){
                            s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                            latlon.push(results.getPoi(i).point.lng+","+results.getPoi(i).point.lat);
                        }
                        var str ='';
                        var a='';
                        for(var i=0;i<s.length;i++){
                            a="wx.php?app=default&act=index&storeid="+storeid+"&lang="+lang+"&qu="+qu+"&latlon="+latlon[i]+"&address="+s[i];
                            str +='<div><b></b><a href='+a+'><span>'+s[i]+'</span></a><div style="clear:both"></div></div>';
                        }
                        $('.addressName').html('');
                        $('.addressName').html(str);
                    }
                }
            };

            var local = new BMap.LocalSearch(mp, options);
            local.search(searchname);


        }
    });
    //单击搜索
    $('.sou').click(function () {
        var searchname = $('input[name=search]').val();
        var options = {
            onSearchComplete: function(results){
                var name = $('input[name=name]').val();
                var phone = $('input[name=phone]').val();
                var mp=$('input[name=mp]').val();
                var storeid=$('input[name=storeid]').val();
                var lang=$('input[name=lang]').val();
                var auxiliary=$('input[name=auxiliary]').val();
                var latlon=$('input[name=latlon]').val();
                var type=$('input[name=type]').val();
                var returnUrl=$('input[name=returnUrl]').val();
                // 判断状态是否正确
                if (local.getStatus() == BMAP_STATUS_SUCCESS){
                    var s = [];
                    var latlon=[];
                    for (var i = 0; i < results.getCurrentNumPois(); i ++){
                        s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                        latlon.push(results.getPoi(i).point.lng+","+results.getPoi(i).point.lat);
                    }
                    var str ='';
                    var a='';
                    for(var i=0;i<s.length;i++){

                        a="wx.php?app=default&act=index&storeid="+storeid+"&lang="+lang+"&qu="+qu+"&latlon="+latlon[i]+"&address="+s[i];
                        str +='<div><b></b><a href='+a+'><span>'+s[i]+'</span></a><div style="clear:both"></div></div>';
                    }
                    $('.addressName').html('');
                    $('.addressName').html(str);
                }
            }
        };
        var local = new BMap.LocalSearch(mp,options);
        local.search(searchname);
    });
    ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
        var _value = e.item.value;
        myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
        /* G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;*/
        document.getElementById('suggestId').blur();
        var options = {
            onSearchComplete: function(results){
                var name = $('input[name=name]').val();
                var phone = $('input[name=phone]').val();
                var mp=$('input[name=mp]').val();
                var storeid=$('input[name=storeid]').val();
                var lang=$('input[name=lang]').val();
                var auxiliary=$('input[name=auxiliary]').val();
                var latlon=$('input[name=latlon]').val();
                var type=$('input[name=type]').val();
                var returnUrl=$('input[name=returnUrl]').val();
                // 判断状态是否正确
                if (local.getStatus() == BMAP_STATUS_SUCCESS){
                    var s = [];
                    var latlon=[];
                    for (var i = 0; i < results.getCurrentNumPois(); i ++){
                        s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                        latlon.push(results.getPoi(i).point.lng+","+results.getPoi(i).point.lat);
                    }
                    var str ='';
                    var a='';
                    for(var i=0;i<s.length;i++){

                        a="wx.php?app=default&act=index&storeid="+storeid+"&lang="+lang+"&qu="+qu+"&latlon="+latlon[i]+"&address="+s[i];
                        str +='<div><b></b><a href='+a+'><span>'+s[i]+'</span></a><div style="clear:both"></div></div>';
                    }
                    $('.addressName').html('');
                    $('.addressName').html(str);
                }
            }
        };

        var local = new BMap.LocalSearch(mp, options);
        local.search(myValue);


    });

    /*    function boxHide() {
            console.log(this.value);
            if (this.value) {
                if (keywords) {//发起某个关键字的提示请求，会引起onSearchComplete的回调
                    ac.search.apply(ac, keywords);
                }
                hideRestAcBox();
            } else {
                hideAcBox();
            }
        }*/

    /*   function setPlace() {
           mp.clearOverlays();    //清除地图上所有覆盖物
           function myFun() {
               var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
               mp.centerAndZoom(pp, 18);
               longitude = pp.lng;
               latitude = pp.lat;
               document.getElementById('longitude').value = longitude;
               document.getElementById('latitude').value = latitude;
   //                                                                mp.addOverlay(new BMap.Marker(pp));    //添加标注
               marker = new BMap.Marker(pp);  // 创建标注
               console.log("创建标注 " + marker);
               mp.addOverlay(marker);  //添加标注
               flag = false;
           }
           var local = new BMap.LocalSearch(mp, {//智能搜索

               onSearchComplete: myFun
           });
           local.search(myValue);
       }*/

    /*    var options = {
            onSearchComplete: function(results){
                // 判断状态是否正确
                if (local.getStatus() == BMAP_STATUS_SUCCESS){
                    var s = [];
                    for (var i = 0; i < results.getCurrentNumPois(); i ++){
                        s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                    }
                    document.getElementById("r-result").innerHTML = s.join("<br/>");
                }
            }
        };
        var local = new BMap.LocalSearch(map, options);
        local.search("公园");*/



</script>

{/literal}
</body>


</html>