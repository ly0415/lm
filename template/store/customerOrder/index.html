<!DOCTYPE html>
<html>
    <head>
        {include file="public/header.html"}
        <style type="text/css" >

            #printOrder .modal-dialog{
                width:300px;
            }
            #printOrder .modal-body>div{
                text-align:left;
                padding:10px 0;
            }
            #printOrder .guig{
                font-weight:bold;
                width:270px;
                word-wrap:break-word;
                white-space:normal;
                word-break:break-all;
            }
            #printOrder .count{
                font-weight:bold;
                text-align:right;
            }
            #printOrder .price{
                color:#ff0000;
                text-align:right;
            }
            .public{
                color:#ff0000;
            }
            #printGui .modal-dialog{
                width:200px;
                height:200px;
            }
            #printGui .modal-body>div{
                line-height:normal;
                text-align: left;
                padding:4px 0;
                width:170px;
                word-wrap:break-word;
                white-space:normal;
                word-break:break-all;
            }
           .cart-span{
               margin-right:20px !important;
           }
        </style>
    </head>
    <body class="hold-transition skin-blue sidebar-mini">
        <div class="wrapper">
            {include file="public/title.html"}
            <!-- Left side column. contains the logo and sidebar -->
            {include file="public/menu.html"}

            <!-- Content Wrapper. Contains page content -->
            {if $lang_id == 1}
        
            {else}
            <div class="content-wrapper">
                {include file="public/headtab.html"}
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        代客订单列表
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i>订单管理</a></li>
                        <li class="active">代客订单列表</li>
                    </ol>
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="box box-primary">
                                <div class="orderlist-box mt30">
                                    <form class="form-inline" style="padding: 0 30px;">
                                        <div class="tabsbox">
                                            <input type="hidden" name="app" value="customerOrder" />
                                            <input type="hidden" name="act" value="index" />
                                            <input type="hidden" name="lang_id" value="{$lang_id}" />
                                            <input type="hidden" name="store_id" value="{$store_id}" />
                                        </div>
                                        <div class="">
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">商品名称：</small>
                                                <input class="form-control" type="text" name="goods_name" placeholder="商品名称" value="{$goods_name}"/>
                                            </div>
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">支付方式：</small>
                                                <input class="form-control" type="text" name="payment_code" placeholder="支付宝/微信..." value="{$payment_code}"/>
                                            </div>
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">收货人：</small>
                                                <input class="form-control" type="text" placeholder="收货人昵称" name="buyer_name" value="{$buyer_name}"/>
                                            </div>
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">收货人电话：</small>
                                                <input class="form-control" type="text" placeholder="收货人电话" name="buyer_phone" value="{$buyer_phone}"/>
                                            </div>
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">订单编号：</small>
                                                <input class="form-control" type="text" name="order_sn" placeholder="订单编号" value="{$order_sn}"/>
                                            </div>   
                                            <!--                                            {if $auth ==1}
                                                                                        <div class="form-group form-group-sm form-mar">
                                                                                            <small class="control-label zm">经销商：</small>
                                                                                            <select class="form-control w160 j_select" name="store_id">
                                                                                                <option value="0">--请选择站点--</option>
                                                                                                {foreach from=$store item=v}
                                                                                                <option value="{$v.id}" {if $store_id == $v.id} selected {/if}>{$v.store_name}</option>
                                                                                                {/foreach}
                                                                                            </select>
                                                                                        </div>  
                                                                                        {/if}-->
                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">处理状态：</small>
                                                <select class="form-control w160 j_select" name="clickandview">
                                                    <option value="0">--选择订单状态--</option>
                                                    <option value="1" {if $clickandview == 1} selected {/if}>--未处理订单--</option>
                                                    <option value="2" {if $clickandview == 2} selected {/if}>--已处理订单--</option>
                                                </select>
                                            </div>

                                            <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">订单状态：</small>
                                                <select class="form-control w160 j_select" name="orderState">
                                                    <option value="0">--选择订单状态--</option>
                                                    <option value="60" {if $orderState == 60} selected {/if}>--已取消订单--</option>
                                                    <option value="10" {if $orderState == 10} selected {/if}>--未付款订单--</option>
                                                    <option value="20" {if $orderState == 20} selected {/if}>--已付款订单--</option>
                                                    <option value="30" {if $orderState == 30} selected {/if}>--已发货订单--</option>
                                                    <option value="40" {if $orderState == 40} selected {/if}>--区域配送订单--</option>
                                                    <option value="50" {if $orderState == 50} selected {/if}>--已收货订单--</option>
                                                </select>
                                            </div>
                                              <div class="form-group form-group-sm form-mar">
                                                <small class="control-label zm">退款状态：</small>
                                                <select class="form-control w160 j_select" name="refund_state">
                                                    <option value="0">--选择退款状态--</option>
                                                    <option value="1" {if $refund_state == 1} selected {/if}>--退款审核--</option>
                                                    <option value="2" {if $refund_state == 2} selected {/if}>--退款成功--</option>
                                                    <option value="3" {if $refund_state == 3} selected {/if}>--退款失败--</option>
                                                </select>
                                            </div>
                                            <div class="form-group form-group-sm form-mar">
                                                <button type="submit" class="btn btn-default btn-sm">
                                                    搜索 <i class="fa fa-search"></i>
                                                </button>
                                            </div>
                                            <!--                                            <br>
                                                                                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:;" > 新订单：<span class="remind hidden-xs h5 "></span></a>
                                                                                        <div class="btn-audio"><audio id="mp3Btn"><source src="/bspm711/assets/admin/dist/remind.mp3" type="audio/mpeg" /></audio></div>-->
                                            <!--                                            <br><br>-->
                                            <!--                                            <div class="mt33">
                                                                                            &nbsp;&nbsp;&nbsp;
                                                                                            <a href="javascript:;" class="btn btn-default btn-sm" id="exportOrder">导出订单</a>
                                                                                        </div>-->
                                        </div>
                                    </form>
                                    <div class="new-table-responsive mt30">
                                        <div class="box-body table-responsive no-padding ">
                                            <table class="table orderlist-table table-bordered" id="tbl">
                                                <thead>
                                                    <tr> 
                                                        <th colspan="2" style="font-weight:800">商品信息</th>      
                                                        <th style="font-weight:800">商品数量</th>
                                                        <th style="font-weight:800">商品价格</th>
                                                        <th style="font-weight:800">所属平台</th>
                                                        <th style="font-weight:800">退款状态</th>
                                                    </tr>
                                                </thead>
                                                {foreach from=$data item=item}
                                                <tbody>
                                                    <tr class="firsttr">
                                                        <td colspan="6">
                                                            <div class="pull-left">
                                                                <input type="hidden" name="order_id" value="{$item.order_sn}">
                                                                <a href="store.php?app=customerOrder&act=details&lang_id={$lang_id}&order_id={$item.order_id}&p={$p}"> {$item.order_sn}</a>&nbsp;&nbsp;
                                                                <span>下单时间：{$item.add_time|date_format:"%Y-%m-%d"}&nbsp;&nbsp;</span>
                                                                <span>订单来源：{if $item.is_source == 1}微信下单{else}代客下单{/if}</span>
                                                                {if $item['order_state'] >0}
                                                                    <span>&nbsp;&nbsp;&nbsp;{$item.shippingMethod}</span>
                                                                {/if}
                                                                <span> 自提时间: {if $item.pei_time} {$item.pei_time|date_format:"H:i"} {else} ---- {/if}
                                                                </span>
                                                                {if $item['order_state']>=20}
                                                                    <span><a href="store.php?app=customerOrder&act=windowPrint&order_sn={$item.order_sn}" class="uline or">票据打印</a></span>
                                                                {/if}
                                                            </div>
                                                            <div class="pull-right">
                                                                {if !$item.fx_phone && $item.order_state != 0 && $item.order_state != 10}
                                                                <span id="appoint" class="btn btn-primary btn-sm" onclick="appoint('{$item.order_sn}')">指定三级分销人员</span>
                                                                {/if}
                                                                <a href="store.php?app=customerOrder&act=details&lang_id={$lang_id}&order_id={$item.order_id}&p={$p}" class="btn btn-primary btn-sm">订单详情</a>
                                                                <!--  <a href="##" class="btn btn-primary btn-sm ml10">查看物流</a>
                                                                      <a href="##" class="btn btn-primary btn-sm ml10">更改物流</a>
                                                                      <a href="##" class="btn btn-primary btn-sm ml10">客服留言</a>-->
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {foreach $item['goods_list'] as  $good}
                                                    <tr>
                                                        <td width="70px">
                                                            <img src="{$good.goods_image}" width="60" height="45">
                                                        </td>
                                                        <td class="col-md-4">
                                                            <div class="wts">
                                                                <div class="tl">
                                                                    {$good['goods_name']}
                                                                </div>
                                                                <div class="tl gy">
                                                                    产品规格:{$good['spec_key_name']}
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td> X{$good['goods_num']} </td>  
                                                        <td>{$symbol}{$good['goods_pay_price']}</td>
                                                        {if $item.source_id =='1758421'}
                                                        <td>
                                                            <img src="{$STATIC_URL}/admin/images/1527643876.png" width="120" height="45">
                                                        </td>  
                                                        {else}
                                                        <td>  
                                                            <img src="{$item['img']}" width="120" height="45"> 
                                                            {/if}
                                                        </td>  
                                                        {if $good['refund_state'] == 0}
                                                        <td>无退款</td>
                                                        {else if $good['refund_state'] == 1}
                                                        <td>退款审核中</td>
                                                        {else if $good['refund_state'] == 2}
                                                        <td>已退款</td>
                                                        {else}
                                                        <td>退款失败</td>
                                                        {/if}
                                                    </tr>
                                                    {/foreach}
                                                    {foreach $item['gift'] as  $gift}
                                                    <tr>
                                                        <td width="70px">
                                                            <img src="{$gift.goods_img}" width="60" height="45">
                                                        </td>
                                                        <td class="col-md-4">
                                                            <div class="wts">
                                                                <div class="tl">
                                                                    {$gift['goods_name']}
                                                                </div>
                                                                <div class="tl gy">
                                                                    产品规格:{$gift['goods_key_name']}
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div>X{$gift['gift_num']}</div>
                                                        </td> 
                                                        <td></td>
                                                        {if $item.source_id =='1758421'}
                                                        <td>
                                                            <img src="{$STATIC_URL}/admin/images/1527643876.png" width="120" height="45">
                                                        </td>  
                                                        {else}
                                                        <td>  
                                                            <img src="{$item['img']}" width="120" height="45"> 
                                                        </td>  
                                                        {/if}
                                                        <td>
                                                            <div>赠品（买赠活动）</div>
                                                        </td>
                                                    </tr>
                                                    {/foreach}
                                                    <tr class="" >
                                                        <td colspan="6" style="text-align: left">

                                                            <span class="rd cart-span">订单总金额：{$symbol}{$item.goods_amount}</span>
                                                            <span class="rd cart-span">实收金额：{$symbol}{$item.order_amount}</span>
                                                            {if $item.discount neq 0 }
                                                            <span class="rd cart-span">优惠金额：{$symbol}{$item.discount}</span>
                                                            {/if}
                                                            {if $item.pd_amount neq 0 }
                                                            <span class="rd cart-span">睿积分优惠：{$symbol}{$item.pd_amount}</span>
                                                            {/if}
                                                            {if $item.cp_amount neq 0 }
                                                            <span class="rd cart-span">优惠券优惠：{$symbol}{$item.cp_amount}</span>
                                                            {/if}
                                                            <span class="rd cart-span">配送费：{$symbol}{if $item.shipping_fee ==''}0.00{else}{$item.shipping_fee}{/if}</span>
                                                            <br/>
                                                            <span class="cart-span">收货人：{$item.buyer_name}</span>
                                                            <span class="cart-span">收货电话：{$item.buyer_phone}</span>
                                                            {foreach $status as $key=>$val}
                                                            {if $key == $item['order_state']}
                                                            <span class="cart-span">订单状态：{$val}</span>
                                                            {/if}
                                                            {/foreach}
                                                            {if $item.Appoint==1 && $item.order_state>=20}
                                                            <span class="btn btn-primary btn-sm Appoint" id="{$item.order_id}" style="border-radius: 25px;-webkit-border-radius: 25px;-moz-border-radius: 25px;padding: 2px 10px">接单</span>
                                                            {/if}
                                                            {if $item.order_state>=20 && $sendVoucher &&  !$item.sendVoucher && !$item.dui }
                                                            <span class="btn btn-primary btn-sm sendVoucher {$item.order_id}" data-id="{$item.order_id}"  style="border-radius: 25px;-webkit-border-radius: 25px;-moz-border-radius: 25px;padding: 2px 10px">赠送兑换劵</span>
                                                            {/if}
                                                            {if $item.sub_user neq 2 }
                                                            <span class=" cart-span">下单人员：店员下单</span>
                                                            {else}     
                                                            <span class=" cart-span">下单人员：顾客下单</span>
                                                            {/if}
                                                            <!--                                                                                                                        <span class="cart-span">退货状态：无</span>-->
                                                        </td>
                                                    </tr>                                     
                                                </tbody>
                                                {/foreach}
                                            </table>
                                        </div>
                                    </div> 
                                    <div class="box-footer clearfix"> 
                                        {$page_html}
                                    </div>
                                </div>  
                            </div>
                            <!-- /.box -->
                        </div>
                    </div>
                </section>
                <!-- /.content -->
            </div>
            <!-- /.content-wrapper -->     
            {include file="public/footer.html"}
            {/if}
            <!--            <script type="text/javascript">
                            setInterval(function () {
                                window.location.reload();
                            }, 22000)
                        </script>-->
            <!--            {literal}
                        <script type="text/javascript">
                            $(function () {
                                //播放器控制
                                var audio = document.getElementById('mp3Btn');
                                audio.play(); //播放
                            })
                        </script>
                        <script type="text/javascript">
                            var remind = 1;
                            var audio = document.getElementById('mp3Btn');
                            //                console.log(mp3);
                            var play = 0;
                            if (sessionStorage.num) {
                                $(".remind").text(sessionStorage.num);
                            }
                            setInterval(function () {
                                $.ajax({
                                    url: "?app=customerOrder&act=sendOrderNotice",
                                    success: function (data) {
                                        var data = eval("(" + data + ")");
                                        remind = data[0]['total'];
                                        sessionStorage.num = data[0]['total'];
                                        if (play == remind) {
                                            remind <= 0 ? $(".remind").hide() : $(".remind").show()
                                        } else {
                                            $(".remind").show().text(remind);
                                            audio.play();
                                            console.log(audio);
                                            //                                window.android.playNewOrderSound();
                                            play = remind;
                                        }
                                    }
                                })
                            }, 5000)
                        </script>
                        {/literal}-->
            <script type="text/javascript">



            /*    $(function(){
                    layui.use('laydate', function(){
                        var laydate = layui.laydate;
                        laydate.render({
                            elem: '.dataTime'
                            ,type: 'time'
                        });
                    });
                })*/
                $("#exportOrder").click(function () {
                    var url = "?app=customerOrder&act=exportOrder";
//                    var username = $('#username').val();
//                    if (username) {
//                        url += "&username=" + username;
//                    }
                    location.href = url;

                });
            function appoint(order_sn) {
                setTimeout(function() {
                    dialog_form_radio('store.php?app=orderList&act=appoint_en&lang_id=0&application=customerOrder&action=index&order_sn='+order_sn, '选择分销人员');
                }, 100);
            }
            function dialog_form_radio(file_url, title) {
                $.get(file_url, function(data) {
                    $.confirm({
                        boxWidth: '50%',
                        useBootstrap: false,
                        title: title,
                        content: data,
                        animationBounce: 1.5,
                        type: 'blue',
                        buttons: {
                            confirm: {
                                btnClass: 'btn-blue',
                                text: '保存',
                                action: function() {
                                    var data = $('#distributor').serialize();
                                    $.ajax({
                                        url: '?app=orderList&act=appoint_en',
                                        type: 'POST',
                                        data: data,
                                        dataType: "json",
                                        success: function(data) {
                                            if (data.status == 1) {
                                                var d = $.dialog({
                                                    content: '<div class="text-center">' + data.message + '</div>',
                                                    title: false, // hides the title.
                                                    closeIcon: false, // hides the close icon.
                                                    columnClass: 'xsmall',
                                                    onOpen: function() {
                                                        setTimeout(function() {
                                                            d.close();
                                                        }, 1000);
                                                        window.location.href = data.info.url;
                                                    }
                                                });
                                                return false;
                                            } else {
                                                var d = $.dialog({
                                                    content: '<div class="text-center">' + data.message + '</div>',
                                                    title: false, // hides the title.
                                                    closeIcon: false, // hides the close icon.
                                                    columnClass: 'xsmall',
                                                    onOpen: function() {
                                                        setTimeout(function() {
                                                            d.close();
                                                        }, 1000);
                                                    }
                                                });
                                                return false;
                                            }
                                        }
                                    });
                                }
                            },
                            cancel: {
                                btnClass: 'btn-default', // multiple classes.
                                text: '取消'
                            }
                        }
                    });
                })
            }
            </script>
            //接单按钮
            {if $ccccc ==1}
            <script src="http://www.njbsds.cn/bspm711/assets/public/js/loading.js"></script>
            <script type="text/javascript">
                loading();
                function loading(){
                    $('body').loading({
                        loadingWidth:220,
                        title:'提示',
                        name:'print',
                        titleColor:'#fff',
                        discColor:'#EDEEE9',
                        discription:'票据打印中，请稍等...',
                        direction:'column',
                        type:'origin',
                        originBg:'#ECCFBB',
                        originDivWidth:40,
                        originDivHeight:40,
                        originWidth:6,
                        originHeight:6,
                        smallLoading:false,
                        loadingMaskBg:'rgba(0,0,0,0.2)'
                    });
                    setTimeout(function(){
                        removeLoading('print');
                    },3000);
                }
                //关闭Loading
                function removeLoading(loadingName){
                    var loadingName = loadingName || '';
                    $('body,html').css({
                        overflow:'auto',
                    });
                    if(loadingName == ''){
                        $(".cpt-loading-mask").remove();
                    }else{
                        var name = loadingName || 'loadingName';
                        $(".cpt-loading-mask[data-name="+name+"]").remove();
                    }
                }
            </script>
            {/if}
            {literal}
            <script type="text/javascript">
                $(".Appoint").click(function () {
                    var order_sn =$(this).parent().parent().siblings('.firsttr').find('input[name=order_id]').val();
                    var lang_id = $('input[name=lang_id]').val();
                    var id =$(this).attr("id");
                    var p = $('input[name=p]').val();
                    layer.confirm('您确定要接受此订单？', {
                        btn: ['确定', '取消'],
                        title: '提示',
                        icon: 0,
                        skin: 'firm-layer',
                        yes: function (index) {
                            $.ajax({
                                url: "store.php?app=customerOrder&act=editAAppoint&lang_id=" + lang_id,
                                data: {order_sn: order_sn, lang_id: lang_id, p: p},
                                type: "POST",
                                dataType: "json",
                                success: function (res) {
                                    if (res.status == '1') {
                                        layer.alert(res.message, {
                                            icon: 1,
                                            btn: false,
                                            title: false,
                                            closeBtn: 0,
                                            time: 500,
                                            skin: 'alt-layer'
                                        });
                                       /* $(".cart-span").html("区域已配送");*/

                                        $("#"+id).prev('.cart-span').html("订单状态 ： 区域已配送");
                                        $("#"+id).remove();
                                    } else {
                                        layer.alert(res.message, {
                                            icon: 1,
                                            btn: false,
                                            title: false,
                                            closeBtn: 0,
                                            time: 500,
                                            skin: 'alt-layer'
                                        });
                                    }
                                }
                            })
                        }
                    })
                });

                //赠送兑换劵
                $(".sendVoucher").click(function(){
                    var order_sn =$(this).parent().parent().siblings('.firsttr').find('input[name=order_id]').val();
                    var order_id=$(this).attr('data-id');
                    setTimeout(function() {
                            dialog_form_radio('store.php?app=customerOrder&act=voucherList', '兑换券列表');
                        }, 100);
                    function dialog_form_radio(file_url,title) {
                        $.get(file_url,function (data) {
                            $.confirm({
                                boxWidth:'60%',
                                useBootstrap:false,
                                title:title,
                                content:data,
                                animationBounce:1.5,
                                type:'blue',
                                buttons:{
                                    confirm:{
                                        btnClass:'btn-blue',
                                        text:'赠送',
                                        action:function () {
                                            var voucherId =  $('.type_name:checked').attr("data-id");
                                            $.ajax({
                                                url: "store.php?app=customerOrder&act=sendVoucher",
                                                data: {order_sn: order_sn, voucherId: voucherId},
                                                type: "POST",
                                                dataType: "json",
                                                success: function (res) {
                                                    if (res.status == '1') {
                                                        layer.alert(res.message, {
                                                            icon: 1,
                                                            btn: false,
                                                            title: false,
                                                            closeBtn: 0,
                                                            time: 500,
                                                            skin: 'alt-layer'
                                                        });
                                                        $("."+order_id).remove();
                                                    } else {
                                                        layer.alert(res.message, {
                                                            icon: 1,
                                                            btn: false,
                                                            title: false,
                                                            closeBtn: 0,
                                                            time: 1000,
                                                            skin: 'alt-layer'
                                                        });
                                                    }
                                                }
                                            })
                                        }
                                    },
                                    cancel:{
                                        btnClass:'btn-default',
                                        text:'取消'
                                    }
                                }
                            })
                        })
                    }
                })
            </script>
            {/literal}
    </body>
</html>
