<!DOCTYPE html>
<html>
    <head>
        {include file="public/header.html"}
        <style>
            .coupon_name input{
                border: none;
                background: none;
            }
        </style>
    </head>
    <body class="hold-transition skin-blue sidebar-mini">
        <div class="wrapper">
            {include file="public/title.html"}
            <!-- Left side column. contains the logo and sidebar -->
            {include file="public/menu.html"}
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">

                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>
                        {$language1->electronic_coupon}
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="store.php?app=default&act=index"><i class="fa fa-dashboard"></i> {$language1->index}</a></li>
                        <li class="active">{$language1->electronic_coupon}</li>
                        <li class="active">{$language1->deduction_list}</li>
                    </ol>
                </section>
                <!-- Main content -->
                <section class="content">
                    <ul id="myTab" class="nav nav-tabs">
                        <li class="active">
                            <a href="#home" data-toggle="tab">
                                {$language1->deduction_coupon}
                            </a>
                        </li>
                        <li><a href="?app=coupon&act=index&op=dui">兑换券</a></li>
                    </ul>
                    <!-- /.row -->
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="box box-primary">
                                <div class="box-header">
                                    <form class="form-inline col-sm-10 col-md-11 no-padding">
                                       <input type='hidden' name='app' value='coupon'>
                                        <input type='hidden' name='act' value='index'>
                                        <input type="hidden" name = "delAll" value="dele">
                                    </form>
                                    <input type="hidden"  name="user_name" id="user_name" value="" >
                                    <input type="hidden"  name="user_id" id="user_id" value="" >
                                    <div class="col-sm-2  col-md-1 no-padding">
                                        <a class="btn btn-primary pull-right btn-sm" href="?app=coupon&act=add"   role="button"><i class="fa fa-plus"></i> {$language2->add_to}{$language1->deduction_coupon}</a>
                                    </div>
                                </div>
                                <div class="new-table-responsive">
                                    <div class="box-body table-responsive no-padding">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{$language2->serial_number}</th>
                                                    <th>{$language1->deduction_coupon}{$language2->name}</th>
                                                    <th>{$language1->satisfy_amount}</th>
                                                    <th>{$language1->reduction_amount}</th>
                                                    <!--<th>总使用次数</th>-->
                                                    <th>{$language1->usage_day}</th>
                                                    <th>{$language1->valid_date}</th>
                                                <!--    <th>开始时间</th>
                                                    <th>结束时间</th>-->
                                                    <th>{$language2->add_time}</th>
                                                    <th>{$language2->control}</th>
                                                </tr>
                                            </thead>
                                            {foreach from=$couponData item=item}
                                            <tr>
                                                <td>{$item.sort_id}</td>
                                                <td class="coupon_name" data-id="{$item.id}"><input type="text" name="" id="" value="{$item.coupon_name}"></td>
                                                <td >{$item.money}</td>
                                                <td>{$item.discount}</td>
                                                <!--<td>{$item.total_times}</td>-->
                                                <td>{$item.day_times}</td>
                                                <td>{$item.limit_times}</td>
                                             <!--   <td>{$item.start_time}</td>
                                                <td>{$item.end_time}</td>-->
                                                <td>{$item.add_time}</td>
                                                <td>

                                                    <a href="javascript:;" data-toggle="tooltip" class="btn btn-xs btn-success paison useradd " id="{$item.id}"  data-id="{$item.id}"  style="overflow: hidden; position: relative;">{$language2->sent}</a>
                                                    {if $item.display !=1}
                                                    <!--<a href="?app=coupon&act=edit&id={$item.id}" data-toggle="tooltip" class="btn btn-xs btn-success  "    data-id="{$item.id}"  style="overflow: hidden; position: relative;">编辑</a>-->
                                                    <a href="javascript:;" data-toggle="tooltip" class="btn btn-xs btn-danger "  onclick="shanchu({$item.id});"   style="overflow: hidden; position: relative;">{$language2->drop}</a>
                                                    {/if}
                                                </td>
                                            </tr>
                                            {/foreach}
                                        </table>
                                    </div>
                                </div>
                                <div class="box-footer clearfix">
                                    {$page_html}
                                </div>
                                <!-- /.box-body -->
                            </div>
                        </div>
                    </div>
                </section>
                <!-- /.content -->
            </div>
            <input type="hidden" name="p" value="{$p}">
            {include file="public/footer.html"}
        </div>
        {literal}
        <script type="text/javascript">
            $(".coupon_name input").blur(function () {
               var text = $(this).val();
               var id = $(this).parent().attr('data-id');
               var p = $("input[name=p]").val();
               $.ajax({
                   url:"?app=coupon&act=editCouponName",
                   type:"POST",
                   dataType:'json',
                   data:{'text':text,'id':id,'p':p},
                   success:function (res) {
                       if (res.status == 1){
                           window.location.href = res.info.url;
                       }
                   }
               })
            });
  
            /*删除*/
            function shanchu(id) {
                deletes('?app=coupon&act=del&id=' + id);
            }
            //编辑
            function edit(id){
                var data={'id':id};
                $.ajax({
                    url:'?app=coupon&act=checkEdit',
                    type:'POST',
                    data:data,
                    dataType:'json',
                    success:function (data) {
                        if (data.status == 1){
                            var d = $.dialog({
                                content: '<div class="text-center">' + data.message + '</div>',
                                title: false, // hides the title.
                                closeIcon: false, // hides the close icon.
                                columnClass: 'xsmall',
                                onOpen: function () {
                                    setTimeout(function () {
                                        d.close();
                                    }, 1000);
                                    window.location.href = data.info.url;
                                }
                            });
                            return false;
                        }else{
                            var d = $.dialog({
                                content: '<div class="text-center">' + data.message + '</div>',
                                title: false, // hides the title.
                                closeIcon: false, // hides the close icon.
                                columnClass: 'xsmall',
                                onOpen: function () {
                                    setTimeout(function () {
                                        d.close();
                                    }, 1000);
                                }
                            });
                            return false;
                        }
                    }
                })
            }

            //选择用户
            $('.useradd').click(function() {
                var user_id = $('input[name="user_id"]').val();
                var user_name = $('input[name="name"]').val();
                var coupon_id =$(this).attr('id');
                if (user_id) {
                    var file_url = '?app=coupon&act=selectUser&user_id='+user_id+'&user_name='+user_name;
                } else {
                    var file_url = '?app=coupon&act=selectUser';
                }
                var title = '选择用户';
                $.get(file_url, function(data) {
                    $.confirm({
                        boxWidth: '50%',
                        useBootstrap: false,
                        title: title,
                        content: data,
                        animationBounce: 1.5,
                        type: 'blue',
                        buttons: {
                            confirm: {
                                btnClass: 'btn-blue',
                                text: '保存',
                                action: function() {
                                    var id = $('#user_id').val();

                                    var user_name = $('#user_name').val();
                                    $('input[name="name"]').val(user_name);
                                    $('input[name="user_id"]').val(id);
                                    var data = {'id':id,'couponId':coupon_id};
                                    $.ajax({
                                        url:'?app=coupon&act=sendCoupon',
                                        type:'POST',
                                        data:data,
                                        dataType:'json',
                                        success:function (data) {
                                            if (data.status == 1){
                                                var d = $.dialog({
                                                    content: '<div class="text-center">' + data.message + '</div>',
                                                    title: false, // hides the title.
                                                    closeIcon: false, // hides the close icon.
                                                    columnClass: 'xsmall',
                                                    onOpen: function () {
                                                        setTimeout(function () {
                                                            d.close();
                                                        }, 1000);
                                                        window.location.href = data.info.url;
                                                    }
                                                });
                                                return false;
                                            }else{
                                                var d = $.dialog({
                                                    content: '<div class="text-center">' + data.message + '</div>',
                                                    title: false, // hides the title.
                                                    closeIcon: false, // hides the close icon.
                                                    columnClass: 'xsmall',
                                                    onOpen: function () {
                                                        setTimeout(function () {
                                                            d.close();
                                                        }, 1000);
                                                    }
                                                });
                                                return false;
                                            }
                                        }
                                    })
                                }
                            },
                            cancel: {
                                btnClass: 'btn-default', // multiple classes.
                                text: '取消'
                            }
                        }
                    });

                })
            });
        </script>
        {/literal}
    </body>
</html>
