<!DOCTYPE html>
<html>
<head>

    {include file="public/header.html"}

</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

    {include file="public/title.html"}
    {include file="public/menu.html"}
    <div class="content-wrapper">
        <section class="content-header">
            <h1>
                {$language1->send_user}
            </h1>
            <ol class="breadcrumb">
                <li><a href="store.php?app=default&act=index"><i class="fa fa-dashboard"></i> </a></li>
                <li class="active">{$language1->deduction_coupon}</li>
                <li class="active"> {$language1->send_user}</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <!-- right column -->
                <div class="col-xs-12">
                    <!-- Horizontal Form -->
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <h3 class="box-title"></h3>
                        </div>
                        <!-- /.box-header -->
                        <!-- form start -->
                        <div class="form-horizontal">
                            <div class="box-body">
                                <div class="form-group">
                                    <label class="col-sm-4 col-md-2  col-lg-2 control-label"><span class="text-red">*</span> {$language1->redemption_voucher}：</label>
                                    <div class="numInput">
                                        <input type="text" name="numbers" class="form-control" style="width: 266px;display: inline-block"><span style="padding-left: 10px;">({$language1->per_person})</span>
                                    </div>

                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 col-md-2  col-lg-2 control-label"><span class="text-red">*</span> {$language1->send_user}：</label>
                                    <div class="col-sm-6 col-md-5 col-lg-4">
                                        <input type="radio"  name="category"  value="1" checked onclick="choose(this);" > {$language1->all_person}
                                        <input type="radio"  name="category" value="2"  onclick="choose(this);" > {$language1->designated_person}
                                    </div>
                                </div>
                                <div class="form-group display3" style="display: none">
                                    <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red">*</span>{$language1->member}：</label>
                                    <div class="col-sm-6 col-md-5 col-lg-4">
                                        <input type="text" class="form-control" name="username" readonly>
                                        <input type="hidden" name="user_id">
                                    </div>
                                    <div class="col-xs-1"><span class="btn btn-primary" id="goods">{$language1->member}</span></div>
                                </div>
                            </div>
                            <!-- /.box-body -->
                            <div class="box-footer">
                                <div class="form-group">
                                    <div class="col-sm-6 col-sm-offset-4 col-md-5 col-md-offset-2 col-lg-4 col-lg-offset-2">
                                        <a href="admin.php?app=coupon&act=index" class="btn btn-default"><i class="fa fa-times-circle"></i> {$language2->close}</a>
                                        <button class="btn btn-primary pull-right" type="button" id="submit"><i class="fa fa-save"></i> {$language2->save}</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="store_id" value="{$store_id}">
                            <input type="hidden" name="c_id" value="{$id}">
                            <input type="hidden"  name="p" value="{$p}" />
                        </div>>
                    </div>
                </div>
            </div>
        </section>
    </div>
    {include file="public/footer.html"}

</div>
{literal}
<script type="text/javascript">
    //选择会员
    $('#goods').click(function() {
        setTimeout(function() {
            dialog_form_radio('admin.php?app=coupon&act=getUser', '用户');
        }, 100);
    });
    function dialog_form_radio(file_url,title) {
        $.get(file_url,function (data) {
            $.confirm({
                boxWidth:'80%',
                useBootstrap:false,
                title:title,
                content:data,
                animationBounce:1.5,
                type:'blue',
                buttons:{
                    confirm:{
                        btnClass:'btn-blue',
                        text:'保存',
                        action:function () {
                            var id_array=new Array();
                            var arr = new Array();
                            $('.radio-name:checked').each(function (i,v) {
                                id_array.push($(this).attr('data-id'));
                                arr.push($(this).attr('data-name'));
                            });
                            var idstr=id_array.join(',');
                            var arrs=arr.join(',');
                            $('input[name=username]').val(arrs);
                            $('input[name=user_id]').val(idstr);
                        }
                    },
                    cancel:{
                        btnClass:'btn-default',
                        text:'取消'
                    }
                }
            })
        })
    }
    //类别的选择
    function choose(obj) {
        var value = parseInt(obj.value);
        if (value == 1) {
            $('.display2').show();
            $('.display3').hide();
        } else if (value == 2) {
            $('.display3').show();
            $('.display2').hide();
        }
    }

    $("#submit").on('click',function () {
        var store_id = $('input[name=store_id]').val();
        var c_id     = $('input[name=c_id]').val();
        var numbers  = $('input[name=numbers]').val();
        var category = $('input:radio:checked').val();
        var lang_id  = $('input[name=lang_id]').val();
        var p        = $('input[name=p]').val();
        if (!numbers) {
            dialog('请填写劵的数量！');
            return;
        }
        if (category ==1) {
            $.ajax({
                url:"?app=coupon&act=paison1",
                type:"POST",
                data:{'numbers':numbers,'id':c_id,'store_id':store_id,'lang_id':lang_id,'p':p},
                dataType:'json',
                success:function (data) {
                    if (data.status == 1){
                        var d = $.dialog({
                            content: '<div class="text-center">' + data.message + '</div>',
                            title: false, // hides the title.
                            closeIcon: false, // hides the close icon.
                            columnClass: 'xsmall',
                            onOpen: function () {
                                setTimeout(function () {
                                    d.close();
                                }, 1000);
                                window.location.href = data.info.url;
                            }
                        });
                        return false;
                    }else{
                        var d = $.dialog({
                            content: '<div class="text-center">' + data.message + '</div>',
                            title: false, // hides the title.
                            closeIcon: false, // hides the close icon.
                            columnClass: 'xsmall',
                            onOpen: function () {
                                setTimeout(function () {
                                    d.close();
                                }, 1000);
                            }
                        });
                        return false;
                    }
                }
            })
        } else if (category == 2) {
            var user_id  = $('input[name=user_id]').val();
            // console.log(data);return false;
            $.ajax({
                url:"?app=coupon&act=doSend",
                type:'POST',
                data:{'user_id':user_id,'store_id':store_id,'c_id':c_id,'numbers':numbers},
                dataType:'json',
                success:function (data) {
                    if (data.status == 1){
                        var d = $.dialog({
                            content: '<div class="text-center">' + data.message + '</div>',
                            title: false, // hides the title.
                            closeIcon: false, // hides the close icon.
                            columnClass: 'xsmall',
                            onOpen: function () {
                                setTimeout(function () {
                                    d.close();
                                }, 1000);
                                window.location.href = data.info.url;
                            }
                        });
                        return false;
                    }else{
                        var d = $.dialog({
                            content: '<div class="text-center">' + data.message + '</div>',
                            title: false, // hides the title.
                            closeIcon: false, // hides the close icon.
                            columnClass: 'xsmall',
                            onOpen: function () {
                                setTimeout(function () {
                                    d.close();
                                }, 1000);
                            }
                        });
                        return false;
                    }
                }
            })
        }
    });

    function dialog(msg) {
        $.confirm({
            title: '',
            closeIcon: true,
            content: "<i class='fa fa-warning text-yellow' style='font-size:38px'></i>&nbsp;&nbsp; " + msg + "",
            type: 'blue',
            buttons: {
                confirm: {
                    btnClass: 'btn-blue',
                    text: '确认',
                    action: function () {

                    }
                }
            }
        });
        return;
    }
</script>
{/literal}
</body>
</html>


