<!DOCTYPE html>
<html>
<head>

    {include file="public/header.html"}

</head>
<style>
    .changeWidth{
        width: 233px;
    }
</style>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

    {include file="public/title.html"}
    <!-- Left side column. contains the logo and sidebar -->
    {include file="public/menu.html"}

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                兑换券添加
            </h1>
            <ol class="breadcrumb">
                <li><a href="store.php?app=default&act=index"><i class="fa fa-dashboard"></i> </a></li>
                <li class="active">兑换券</li>
                <li class="active">兑换券添加</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <!-- right column -->
                <div class="col-xs-12">
                    <!-- Horizontal Form -->
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <h3 class="box-title"></h3>
                        </div>
                        <!-- /.box-header -->
                        <!-- form start -->
                        <div class="form-horizontal">
                            <div class="box-body">
                                <input type="hidden" value="{$lang_id}" name="lang_id" />
                                <div class="form-group">
                                    <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red">*</span>兑换券名称：</label>
                                    <div class="col-sm-6 col-md-5 col-lg-4">
                                        <input type="text" class="form-control" name="coupon_name" value="兑换券">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red">*</span>{$language1->satisfy_amount}：</label>
                                    <div class="col-sm-6 col-md-5 col-lg-4">
                                        <input type="text" class="form-control" name="money">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red">*</span>{$language1->valid_date}：</label>
                                    <div class="col-sm-6 col-md-5 col-lg-4">
                                        <input type="number" class="form-control" name="limit_times">
                                    </div>
                                </div>
                                <div class="form-group display2" >
                                    <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red">*</span>使用范围：</label>
                                    <div class="col-sm-7 col-md-6 col-lg-5">
                                        <select class="form-control changeWidth j_select inblock j-cate1" name="top_id" id="top">
                                            <option value="0">--请选择一级业务类型--</option>
                                            {foreach from=$type item=item}
                                            <option value="{$item.type_id}">{$item.type_name}</option>
                                            {/foreach}
                                        </select>
                                        <select class="form-control changeWidth j_select inblock" id="type" name="second_id">
                                            <option value="0">--请选择二级业务类型--</option>
                                        </select>
                                    </div>
                                </div>
                                <!--<div class="form-group display2">-->
                                    <!--<label class="col-sm-4 col-md-2 col-lg-2 control-label">二级业务类型</label>-->
                                    <!--<div class="col-sm-6 col-md-5 col-lg-4">-->
                                        <!--<select class="form-control w160 j_select inblock" id="type" name="second_id">-->
                                            <!--<option value="0">&#45;&#45;请选择&#45;&#45;</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                <!--</div>-->
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 col-md-2 col-lg-2 control-label"><span class="text-red"></span>商品ID：</label>
                                <div class="col-sm-6 col-md-5 col-lg-4">
                                    <input type="text" class="form-control" name="goods_id" value="">
                                </div>
                            </div>
                            <!-- /.box-body -->
                            <div class="box-footer">
                                <div class="form-group">
                                    <div class="col-sm-6 col-sm-offset-4 col-md-5 col-md-offset-2 col-lg-4 col-lg-offset-2">
                                        <a href="admin.php?app=coupon&act=index&op=dui&lang_id={$lang_id}" class="btn btn-default"><i class="fa fa-times-circle"></i> {$language2->close}</a>
                                        <button class="btn btn-primary pull-right" type="button" id="submit"><i class="fa fa-save"></i> {$language2->save}</button>
                                    </div>
                                </div>
                            </div>
                            <!--<input type="hidden" name="store_id" value="{$store_id}">-->
                            <input type="hidden" name="lang_id" value="{$lang_id}">
                            <input type="hidden"  name="p" value="{$p}" />
                        </div>
                        <!-- /.box -->
                        <!-- general form elements disabled -->
                    </div>
                    <!-- /.box -->
                </div>
                <!--/.col (right) -->
            </div>
            <!-- /.row -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    {include file="public/footer.html"}

</div>
{literal}
<script type="text/javascript">
    var newDate = new Date();
    var t = newDate.toJSON();
    $('#datepicker1').datetimepicker({
        minView: "month",
        autoclose: true,
        language: 'ch',
        format: "yyyy-mm-dd",
        clearBtn: true,
        startDate: new Date(t),
        timepicker:false,

    });
    $('#datepicker2').datetimepicker({
        minView: "month",
        autoclose: true,
        language: 'ch',
        format: "yyyy-mm-dd",
        clearBtn: true,
        startDate: new Date(t),
        timepicker:false,

    });
    function dialog(msg) {
        $.confirm({
            title: '',
            closeIcon: true,
            content: "<i class='fa fa-warning text-yellow' style='font-size:38px'></i>&nbsp;&nbsp; " + msg + "",
            type: 'blue',
            buttons: {
                confirm: {
                    btnClass: 'btn-blue',
                    text: '确认',
                    action: function () {

                    }
                }
            }
        });
        return;
    }
    function dateTotime(fromDate) {
        var stringTime = fromDate;
        var timestamp2 = Date.parse(new Date(stringTime));
        timestamp2 = timestamp2 / 1000;
        return timestamp2;
    }
    function isNumber(oNum)
    {

        var t=/^\d+(\.\d+)?$/;
        if(t.test(oNum))
        {
            return 1;
        }
        else
        {
            //alert("非法字符");
            return 0;
        }
    }
    $('body').on('click','#submit',function () {
        var start_time = $('input[name=start_time]').val();
        start_time=dateTotime(start_time);
        var end_time = $('input[name=end_time]').val();
        end_time=dateTotime(end_time);
        var lang_id = $('input[name=lang_id]').val();
        var money = $('input[name=money]').val();
        var top = $("#top option:selected").val();
        var second = $("#type option:selected").val();
        var limit_times=$('input[name=limit_times]').val();
        var coupon_name=$("input[name=coupon_name]").val();
        var goods_id=$("input[name=goods_id]").val();
        // alert(top);return false;
    /*    if (!start_time || !end_time) {
            dialog('请填写时间区间！');
            return;
        }
        if (start_time > end_time) {
            dialog('请填写开始时间不能大于结束时间！');
            return;
        }*/
        // if (!times) {
        //     dialog('请填写兑换券的可使用次数！');
        //     return;
        // }
        if (!coupon_name){
            dialog('请填写兑换券名称！');
            return;
        }
        if(!limit_times){
            dialog('请填写兑换券的有效天数！');
            return;
        }
        if (limit_times < 0){
            dialog('有效天数不能低于0！');
            return;
        }
        if (!money) {
            dialog('请填写满足的金额！');
            return;
        }
        if (isNumber(money) == 0){
            dialog('条件金额必须为大于等于0的数！');
            return;
        }
        if (top==0){
            dialog('请选择顶级业务类型！');
            return;
        }
        var data = {'coupon_name':coupon_name,'start_time':start_time,'end_time':end_time,'money':money,'lang_id':lang_id,'top':top,'second':second,'limit_times':limit_times,goods_id:goods_id};
        // console.log(data);return false;
        $.ajax({
            url:'?app=coupon&act=addCoupon',
            type:'POST',
            data:data,
            dataType:'json',
            success:function (data) {
                if (data.status == 1){
                    var d = $.dialog({
                        content: '<div class="text-center">' + data.message + '</div>',
                        title: false, // hides the title.
                        closeIcon: false, // hides the close icon.
                        columnClass: 'xsmall',
                        onOpen: function () {
                            setTimeout(function () {
                                d.close();
                            }, 1000);
                            window.location.href = data.info.url;
                        }
                    });
                    return false;
                }else{
                    var d = $.dialog({
                        content: '<div class="text-center">' + data.message + '</div>',
                        title: false, // hides the title.
                        closeIcon: false, // hides the close icon.
                        columnClass: 'xsmall',
                        onOpen: function () {
                            setTimeout(function () {
                                d.close();
                            }, 1000);
                        }
                    });
                    return false;
                }
            }
        })
    })


</script>
{/literal}
<script>
    $(".j-cate1").on("change",function () {
        var id = $(this).find(":selected").val();
        var url = "?app=coupon&act=secondType&superior_id="+id;
        // alert(url)
        $.ajax({
            type:"POST",
            dataType:"json",
            url:url,
            success:function (data) {
                if (data.status == 1){
                    console.log(data.info);
                    var options = '<option value="0">--请选择二级业务分类--</option>';
                    $.each(data.info, function(i,e){
                        options += '<option value="' + e.type_id + '">' + e.type_name + '</option>';
                    });
                    $('#type').html(options);
                } else {
                    var options = '<option value="0">--请选择二级业务分类--</option>';
                    $('#type').html(options);
                }
            }
        })
    })
</script>
</body>
</html>


